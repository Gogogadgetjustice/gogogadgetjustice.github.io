<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Master Palette Swapper v3</title>
  <style>
    :root { --bg:#0f1115; --panel:#171a21; --text:#e6edf3; --muted:#9aa7b8; --accent:#7aa2f7; --border:#2a2f3a; }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--text);} header{padding:18px 24px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#14171e 0%,var(--panel) 100%);} header h1{margin:0;font-size:20px;} header .sub{color:var(--muted);font-size:12px;}
    .container{display:grid;grid-template-columns:360px 1fr;gap:16px;padding:16px;} .panel{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;} .panel h2{margin:0 0 8px;font-size:16px;} .panel h3{margin:12px 0 6px;font-size:13px;color:var(--muted);} .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;} .col{display:flex;flex-direction:column;gap:6px;} label{font-size:12px;color:var(--muted);} select,input[type="number"]{background:#090b10;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:6px 10px;font-size:13px;min-height:32px;} input[type="range"]{width:100%;} button{background:#121520;color:var(--text);border:1px solid var(--border);border-radius:8px;padding:8px 10px;font-size:13px;cursor:pointer;} .dropzone{border:1.5px dashed var(--border);border-radius:12px;padding:18px;text-align:center;color:var(--muted);} .dropzone.drag{border-color:var(--accent);color:var(--accent);} 
    .thumbs{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;} .thumb{background:#0c0e14;border:1px solid var(--border);border-radius:10px;overflow:hidden;} .thumb canvas{width:100%;aspect-ratio:1/1;display:block;} .thumb .meta{padding:6px 8px;font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .swatches{display:flex;flex-wrap:wrap;gap:6px;} .chip{width:24px;height:24px;border-radius:4px;border:1px solid #0003;cursor:pointer;}
    .preview-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;} .preview{border:1px solid var(--border);border-radius:10px;overflow:hidden;background:#0c0e14;} .preview header{padding:8px 10px;font-size:12px;border-bottom:1px solid var(--border);background:#0f121a;} .preview canvas{width:100%;height:auto;display:block;}
  </style>
</head>
<body>
  <header>
    <h1> Go Go Gadget Palette Swapper v3</h1>
    <div class="sub">Dozens of Palettes Included • Instant preview • Dithering & pre‑processing</div>
  </header>
  <div class="container">
    <section class="panel" id="controls">
      <h2>Source</h2>
      <div class="dropzone" id="dropzone"><strong>Drop image(s)</strong> or <label class="pill" for="fileInput">browse…</label><div class="help">PNG / JPG / GIF / WEBP</div><input id="fileInput" type="file" accept="image/*" multiple style="display:none" /></div>
      <h2 style="margin-top:12px">Palette</h2>
      <div class="row">
        <div class="col" style="flex:1"><label>System</label><select id="systemSelect"></select></div>
        <div class="col" style="flex:1"><label>Palette</label><select id="paletteSelect"></select></div>
        <div class="col" style="flex:1"><label>Max colors to use</label><input id="maxColors" type="number" min="0" max="256" value="0" /></div>
      </div>
      <div class="row">
        <button id="importPalettes">Import Palettes JSON…</button>
      </div>
      <h3>Colors</h3>
      <div id="swatches" class="swatches"></div>

      <h2 style="margin-top:12px">Processing</h2>
      <div class="row">
        <div class="col" style="flex:1"><label>Color distance</label><select id="distanceMode"><option value="rgb">RGB (Euclidean)</option><option value="rgb-gamma">RGB (gamma-corrected)</option><option value="lab-de2000">LAB (ΔE 2000)</option><option value="lab-de76">LAB (ΔE 76)</option><option value="hsv">HSV (weighted)</option></select></div>
        <div class="col" style="flex:1"><label>Dither</label><select id="ditherMode"><option value="none">None</option><option value="ordered4">Ordered (Bayer 4×4)</option><option value="ordered8">Ordered (Bayer 8×8)</option><option value="fs">Floyd–Steinberg</option><option value="jjn">Jarvis–Judice–Ninke</option><option value="atkinson">Atkinson</option></select></div>
      </div>
      <div class="row">
        <div class="col" style="flex:1"><label>Dither strength</label><input id="ditherStrength" type="range" min="0" max="1" step="0.05" value="1" /></div>
        <div class="col" style="flex:1"><label>Gamma (perceptual)</label><input id="gamma" type="range" min="1.0" max="3.0" step="0.05" value="2.2" /></div>
        <div class="col" style="flex:1"><label>Alpha threshold</label><input id="alphaThresh" type="range" min="0" max="255" step="1" value="1" /></div>
      </div>

      <h3>Pre‑processing</h3>
      <div class="row">
        <div class="col" style="flex:1"><label>Brightness</label><input id="brightness" type="range" min="-100" max="100" value="0" /></div>
        <div class="col" style="flex:1"><label>Contrast</label><input id="contrast" type="range" min="-100" max="100" value="0" /></div>
        <div class="col" style="flex:1"><label>Saturation</label><input id="saturation" type="range" min="-100" max="100" value="0" /></div>
      </div>
      <div class="row">
        <div class="col" style="flex:1"><label>Posterize levels</label><input id="posterize" type="number" min="0" max="32" value="0" /></div>
        <div class="col" style="flex:1"><label>Tolerance (Δ acceptable)</label><input id="tolerance" type="number" min="0" max="100" value="0" /></div>
        <div class="col" style="flex:1"><label><input id="grayscale" type="checkbox" /> Grayscale first</label></div>
      </div>

      <h2 style="margin-top:12px">Export</h2>
      <div class="row"><div class="col" style="flex:1"><label>Scale</label><input id="exportScale" type="number" min="1" max="16" value="1" /></div><button id="resetView">Reset View</button><button id="convertAll" class="primary">Convert Images</button><button id="downloadAll" class="success">Download All</button></div>
    </section>

    <section class="panel" id="workspace">
      <h2>Workspace</h2><div id="thumbs" class="thumbs"></div>
      <h2 style="margin-top:12px">Preview</h2>
      <div class="preview-grid">
        <div class="preview"><header>Original <span class="pill" id="origMeta"></span></header><canvas id="origCanvas"></canvas></div>
      <div class="preview"><header>Converted <span class="pill" id="convMeta"></span></header><canvas id="convCanvas"></canvas></div>
      </div>
      <div class="footer"><span class="help">All processing is client‑side. View at 100% browser zoom for crisp pixels.</span><div><button id="downloadPNG" class="success">Download PNG</button><button id="clearAll" class="danger">Clear</button></div></div>
    </section>
  </div>

  <script>
  // Utilities
  const clamp=(v,lo,hi)=>Math.max(lo,Math.min(hi,v));
  const hexToRgb=hex=>{const h=hex.replace('#','');return [parseInt(h.slice(0,2),16),parseInt(h.slice(2,4),16),parseInt(h.slice(4,6),16)];};
  const srgbToLinear=c=>(c<=0.04045?c/12.92:Math.pow((c+0.055)/1.055,2.4));
  function rgbToXyz([r,g,b]){r=srgbToLinear(r/255);g=srgbToLinear(g/255);b=srgbToLinear(b/255);const x=r*0.4124+g*0.3576+b*0.1805;const y=r*0.2126+g*0.7152+b*0.0722;const z=r*0.0193+g*0.1192+b*0.9505;return [x,y,z];}
  function xyzToLab([x,y,z]){const xr=x/0.95047,yr=y/1.0,zr=z/1.08883;const f=t=>(t>0.008856?Math.pow(t,1/3):(7.787*t+16/116));const fx=f(xr),fy=f(yr),fz=f(zr);return [116*fy-16,500*(fx-fy),200*(fy-fz)];}
  const rgbToLab=rgb=>xyzToLab(rgbToXyz(rgb));
  function deltaE76(l1,l2){const dL=l1[0]-l2[0],da=l1[1]-l2[1],db=l1[2]-l2[2];return Math.sqrt(dL*dL+da*da+db*db);} 
  function rgbToHsv([r,g,b]){r/=255;g/=255;b/=255;const max=Math.max(r,g,b),min=Math.min(r,g,b);const d=max-min;let h=0;const s=max===0?0:d/max;const v=max;if(d!==0){switch(max){case r:h=((g-b)/d+(g<b?6:0));break;case g:h=((b-r)/d+2);break;case b:h=((r-g)/d+4);break;}h/=6;}return [h*360,s,v];}
  function hsvDist(h1,h2){let dh=Math.min(Math.abs(h1[0]-h2[0]),360-Math.abs(h1[0]-h2[0]))/180;const ds=Math.abs(h1[1]-h2[1]);const dv=Math.abs(h1[2]-h2[2]);return 2*dh+1.5*ds+dv;}

  // Inlined palettes
  const PALETTES = {"Game Boy": {"Original": {"colors": ["#071821", "#86c06c", "#e0f8cf", "#65ff00"], "description": "4 shades of green-gray"}, "Pocket": {"colors": ["#000000", "#555555", "#aaaaaa", "#ffffff"], "description": "4 shades of gray"}, "Light": {"colors": ["#001a1a", "#305050", "#86a2a2", "#c7dede"], "description": "4 shades of blue-gray"}}, "1-Bits": {"Nokia3310": {"colors": ["#212c28", "#72a488"], "description": "Nokia 3310"}, "NOIRE TRUTH": {"colors": ["#c6baac", "#1e1c32"], "description": "NOIRE TRUTH"}, "IBM 8503": {"colors": ["#2e3037", "#ebe5ce"], "description": "IBM 8503"}, "MACPAINT": {"colors": ["#8bc8fe", "#051b2c"], "description": "MACPAINT"}, "Roboto": {"colors": ["#0a2e44", "#fcffcc"], "description": "Roboto"}, "Station Defenders": {"colors": ["#17141c", "#a692b0"], "description": "Station Defenders"}, "PAPERBACK": {"colors": ["#b8c2b9", "#382b26"], "description": "PAPERBACK"}, "PIXELINK": {"colors": ["#3e232c", "#edf6d6"], "description": "PIXELINK"}, "Postapoc Sunset": {"colors": ["#1d0f44", "#f44e38"], "description": "Postapoc Sunset"}, "PaperPaper": {"colors": ["#3e3e3e", "#f6e7c1"], "description": "PaperPaper"}, "Chasing Light": {"colors": ["#ffff02", "#000000"], "description": "Chasing Light"}, "Macao12": {"colors": ["#fff2df", "#ef243a"], "description": "Macao12"}, "generic milk": {"colors": ["#f5f4e9", "#5b88e2"], "description": "generic milk"}, "Y Neutral Green": {"colors": ["#004c3d", "#ffeaf9"], "description": "Y Neutral Green"}, "Casio Basic": {"colors": ["#000000", "#83b07e"], "description": "Casio Basic"}, "1 Bit Chill": {"colors": ["#110c22", "#c3dce5"], "description": "1 Bit Chill"}, "Manga 1bit": {"colors": ["#171219", "#f2fbeb"], "description": "Manga 1bit"}, "GatoRoboto": {"colors": ["#363636", "#ececec"], "description": "GatoRoboto"}, "4Am": {"colors": ["#e6d4be", "#352b30"], "description": "4Am"}, "1bit Blue": {"colors": ["#0d132a", "#adc3e8"], "description": "1bit Blue"}, "1bit Nostalgia": {"colors": ["#2e253d", "#b0b0b0"], "description": "1bit Nostalgia"}, "basicblackwhite": {"colors": ["#000000", "#ffffff"], "description": "basicblackwhite"}, "endgame": {"colors": ["#1b1233", "#dcf29d"], "description": "endgame"}, "NOTE-2c": {"colors": ["#222a3d", "#edf2e2"], "description": "NOTE-2c"}, "Flowerrs&Asbestos": {"colors": ["#c62b69", "#edf4ff"], "description": "Flowerrs&Asbestos"}, "Coffee Calm": {"colors": ["#211912", "#d9d9d9"], "description": "Coffee Calm"}, "Funky Jam Red": {"colors": ["#920244", "#fec28c"], "description": "Funky Jam Red"}, "Gato": {"colors": ["#282828", "#a9a9a9"], "description": "Gato"}, "1bitpepperpalette": {"colors": ["#100101", "#ebb5b5"], "description": "1bitpepperpalette"}, "1bit green apple": {"colors": ["#000000", "#26c30f"], "description": "1bit green apple"}}, "Other Systems": {"Commodore 64": {"colors": ["#000000", "#626262", "#898989", "#adadad", "#ffffff", "#9f4e44", "#cb7e75", "#6d5412", "#a1683c", "#c9d487", "#9ae29b", "#5cab5e", "#6abfc6", "#887ecb", "#50459b", "#a057a3"], "description": "Commodore 64"}, "NES Standard": {"colors": ["#7c7c7c", "#0000fc", "#0000bc", "#4428bc", "#940084", "#a80020", "#a81000", "#881400"], "description": "Standard NES palette"}, "CGA": {"colors": ["#000000", "#0000aa", "#00aa00", "#00aaaa", "#aa0000", "#aa00aa", "#aa5500", "#aaaaaa", "#555555", "#5555ff", "#55ff55", "#55ffff", "#ff5555", "#ff55ff", "#ffff55", "#ffffff"], "description": "CGA"}, "Ocean": {"colors": ["#ffffff", "#7b7bff", "#00007b", "#000000", "#00ffff", "#0000ff", "#000094", "#000000"], "description": "Ocean-themed palette"}, "TurboGrafx16": {"colors": ["#000000", "#0000aa", "#00aa00", "#00aaaa", "#aa0000", "#aa00aa", "#aa5500", "#aaaaaa", "#555555", "#5555ff", "#55ff55", "#55ffff", "#ff5555", "#ff55ff", "#ffff55", "#ffffff"], "description": "TurboGrafx-16 Palette"}, "Vic-20": {"colors": ["#000000", "#0000aa", "#00aa00", "#00aaaa", "#aa0000", "#aa00aa", "#aa5500", "#aaaaaa"], "description": "Vic-20 Palette"}, "MacintoshII": {"colors": ["#000000", "#ffffff", "#ff0000", "#00ff00", "#0000ff", "#ffff00", "#ff00ff", "#00ffff", "#808080", "#c0c0c0", "#ff8080", "#80ff80", "#8080ff", "#ffff80", "#ff80ff", "#80ffff"], "description": "Macintosh II Palette"}, "Intellivision": {"colors": ["#000000", "#0000aa", "#00aa00", "#00aaaa", "#aa0000", "#aa00aa", "#aa5500", "#aaaaaa"], "description": "Intellivision Palette"}, "ZX-Spectrum": {"colors": ["#000000", "#0000aa", "#00aa00", "#00aaaa", "#aa0000", "#aa00aa", "#aa5500", "#aaaaaa", "#555555", "#5555ff", "#55ff55", "#55ffff", "#ff5555", "#ff55ff", "#ffff55", "#ffffff"], "description": "ZX-Spectrum Palette"}, "SECAM": {"colors": ["#000000", "#0000aa", "#00aa00", "#00aaaa", "#aa0000", "#aa00aa", "#aa5500", "#aaaaaa", "#555555", "#5555ff", "#55ff55", "#55ffff", "#ff5555", "#ff55ff", "#ffff55", "#ffffff"], "description": "SECAM Palette"}, "MasterSystem": {"colors": ["#000000", "#0000aa", "#00aa00", "#00aaaa", "#aa0000", "#aa00aa", "#aa5500", "#aaaaaa", "#555555", "#5555ff", "#55ff55", "#55ffff", "#ff5555", "#ff55ff", "#ffff55", "#ffffff"], "description": "Master System Palette"}}, "Game Boy Color": {"Default": {"colors": ["#ffffff", "#adad84", "#42737b", "#000000", "#ffff7b", "#ff5a00", "#943a00", "#000000"], "description": "8-color default palette"}, "Nature": {"colors": ["#ffffff", "#7bff00", "#007b00", "#000000", "#ffff00", "#ff0000", "#940000", "#000000"], "description": "Nature-themed palette"}, "Ocean": {"colors": ["#ffffff", "#7b7bff", "#00007b", "#000000", "#00ffff", "#0000ff", "#000094", "#000000"], "description": "Ocean-themed palette"}}, "Pretty Palettes": {"Pastel Dreams": {"colors": ["#d7bde2", "#a9cce3", "#a3e4d7", "#f9e79f"], "description": "Soft pastel colors for a dreamy atmosphere."}, "Forest Walk": {"colors": ["#27ae60", "#16a085", "#d35400", "#8e44ad"], "description": "Earthy greens and a pop of orange for a nature vibe."}, "Rgr papercut4": {"colors": ["#0c0c0d", "#3f3d47", "#8b7d73", "#cdb27b"], "description": "papercut ."}, "Sunset Hues": {"colors": ["#f1c40f", "#e67e22", "#e74c3c", "#9b59b6"], "description": "Warm colors inspired by a beautiful sunset."}, "Ocean Depths": {"colors": ["#1b4f72", "#2980b9", "#3498db", "#aed6f1"], "description": "Varying shades of blue for an underwater feel."}, "Nib-Bit": {"colors": ["#000000", "#1b1233", "#00aa00", "#dcf29d"], "description": "1 bit"}, "Retro Vibes": {"colors": ["#f39c12", "#e74c3c", "#3498db", "#2ecc71"], "description": "Bold and bright colors with a retro touch."}}, "lospec": {"Autumn": {"colors": ["#2b2303", "#933513", "#ef975d", "#fffbd1"], "description": "Autumn"}, "GBREMIXED2": {"colors": ["#1b253d", "#377a64", "#9aad5c", "#e3e2d5"], "description": "GBREMIXED2"}, "CMYK - SNURLY": {"colors": ["#35cbc8", "#c93864", "#ffdb85", "#1b192a"], "description": "CMYK - SNURLY"}, "virtual boy": {"colors": ["#ef0000", "#a40000", "#550000", "#000000"], "description": "virtual boy"}, "Game&Watch": {"colors": ["#06160f", "#535b4e", "#b0b3a6", "#efeee8"], "description": "Game&Watch"}, "RedRose": {"colors": ["#260f0d", "#591616", "#991f27", "#cc3d50"], "description": "RedRose"}, "Calico": {"colors": ["#efebdf", "#e8a053", "#936a4e", "#381701"], "description": "Calico"}, "Avalon": {"colors": ["#20759c", "#084062", "#002841", "#000408"], "description": "Avalon"}, "MIKYU": {"colors": ["#111451", "#796095", "#7ddcc9", "#ffe5ff"], "description": "MIKYU"}, "Aether Quartet": {"colors": ["#d1d8ff", "#968f79", "#3c0197", "#2c0148"], "description": "Aether Quartet"}, "RetroBlue": {"colors": ["#ced9ec", "#66b0c7", "#34419d"], "description": "RetroBlue"}, "NightLight": {"colors": ["#0b0926", "#594f7d", "#cc9a6e", "#faf0b9"], "description": "NightLight"}, "Perry Platypus": {"colors": ["#7fbfdf", "#f1f2f3", "#eca550", "#6f3530"], "description": "Perry Platypus"}, "PICKLJUICE": {"colors": ["#3b1c24", "#4d5245", "#96b38f", "#f0e5d8"], "description": "PICKLJUICE"}, "MOSSTONE": {"colors": ["#2e2f35", "#585460", "#93b987", "#fdf4e9"], "description": "MOSSTONE"}, "bronze star": {"colors": ["#14305f", "#305f7b", "#bf9f00", "#cfaf5f"], "description": "bronze star"}, "bumblebit": {"colors": ["#272946", "#eda031", "#e7ffee"], "description": "bumblebit"}, "Anxietaas": {"colors": ["#ffee96", "#e08e49", "#842243", "#2c1415"], "description": "Anxietaas"}, "Sunset Latern": {"colors": ["#523237", "#ab645a", "#e39b7f", "#f9cda6"], "description": "Sunset Latern"}, "Minimal Red": {"colors": ["#fefefe", "#ed3237", "#373435"], "description": "Minimal Red"}, "BlueSnow": {"colors": ["#a4a4a4", "#4b4b4b", "#8080ff"], "description": "BlueSnow"}, "Taco Bell Table": {"colors": ["#266b90", "#9b63bf", "#e477b6", "#fff3f3"], "description": "Taco Bell Table"}, "papertiger": {"colors": ["#191818", "#81634d", "#a5906d", "#d4c8bb"], "description": "papertiger"}, "n-brulee": {"colors": ["#381a31", "#8e43a1", "#e9edff", "#caa860"], "description": "n-brulee"}, "borealis": {"colors": ["#ffdbb6", "#db926d", "#496d6d", "#242449"], "description": "borealis"}, "classic red": {"colors": ["#20181c", "#d84444", "#a23039", "#792336"], "description": "classic red"}, "gb noodz": {"colors": ["#4c4139", "#9a747f", "#ccb4a4", "#e5dacd"], "description": "gb noodz"}, "cold sweater": {"colors": ["#10081a", "#78a7f5", "#fcd19b", "#ffffff"], "description": "cold sweater"}}, "lopsec 2": {"COLDGB": {"colors": ["#220022", "#334455", "#779988", "#ffffdd"], "description": "COLDGB"}, "Propaganda": {"colors": ["#18181e", "#453d34", "#8f5b5b", "#bdafa8"], "description": "Propaganda"}, "Gb-Armanita": {"colors": ["#662959", "#a56368", "#bfb1a2", "#f0ebd8"], "description": "Gb-Armanita"}, "Homework": {"colors": ["#e1d8d4", "#878c9d", "#45568d", "#12121b"], "description": "Homework"}, "HallowPal": {"colors": ["#4d1f00", "#9b32af", "#f06923", "#bbbab0"], "description": "HallowPal"}, "lt greens": {"colors": ["#f4fbd0", "#68cf68", "#1e9178", "#05241f"], "description": "lt greens"}, "eb gb banana": {"colors": ["#edf2b8", "#c4d23a", "#876a4e", "#382137"], "description": "eb gb banana"}, "Naples": {"colors": ["#f7f6e2", "#ffd7c1", "#af9170", "#5f4b1f"], "description": "Naples"}, "steampunk": {"colors": ["#bebc99", "#6f8b6c", "#4f485e", "#171a24"], "description": "steampunk"}, "Optimized Greyscale": {"colors": ["#dfdfdf", "#9f9f9f", "#606060", "#202020"], "description": "Optimized Greyscale"}, "LOSTGB": {"colors": ["#141319", "#30303d", "#7b7aa4", "#dadada"], "description": "LOSTGB"}, "Sanguine": {"colors": ["#bba075", "#734940", "#641010", "#28000e"], "description": "Sanguine"}, "TechnoBike": {"colors": ["#1d2938", "#2a616e", "#13b37e", "#07ef5c"], "description": "TechnoBike"}, "BlueSemi": {"colors": ["#d0f4f8", "#70b0c0", "#3c3468", "#1c0820"], "description": "BlueSemi"}, "Desat": {"colors": ["#291a1f", "#675650", "#bea87d", "#f0e0cf"], "description": "Desat"}, "Vireo": {"colors": ["#27393f", "#6f535b", "#649092", "#cfc89d"], "description": "Vireo"}, "Old Mug": {"colors": ["#f3eece", "#c0af90", "#3f5956", "#252b3a"], "description": "Old Mug"}, "Gooseberry Thistle": {"colors": ["#48376c", "#6c56ab", "#b883b9", "#bfdce1"], "description": "Gooseberry Thistle"}, "PEANUT BUTTER GB": {"colors": ["#e3e6c5", "#d98d3d", "#784141", "#38192d"], "description": "PEANUT BUTTER GB"}, "MYSTIQUElIFE": {"colors": ["#502a45", "#816ea0", "#87bac5"], "description": "MYSTIQUElIFE"}, "BlackTar": {"colors": ["#843c35", "#ffeb94", "#398a75", "#26153a"], "description": "BlackTar"}, "Droplets": {"colors": ["#0b1424", "#25375c", "#5c7391", "#aec3d6"], "description": "Droplets"}, "Sunrise": {"colors": ["#171726", "#804055", "#d99d62", "#fff2d9"], "description": "Sunrise"}, "grapetree": {"colors": ["#cfb690", "#845a78", "#4c4138", "#17072b"], "description": "grapetree"}, "Mœbius": {"colors": ["#f1e0cd", "#ffa49a", "#da3467", "#35333f"], "description": "Mœbius"}, "bloodlust": {"colors": ["#382637", "#782f51", "#c33149", "#dea257"], "description": "bloodlust"}, "Weekly Release": {"colors": ["#cccec7", "#a09f97", "#77746f", "#2e2622"], "description": "Weekly Release"}, "BMO": {"colors": ["#101e2b", "#183a42", "#407c84", "#8bbe93"], "description": "BMO"}, "DMG-01": {"colors": ["#1b2a09", "#0e450b", "#496b22", "#9a9e3f"], "description": "DMG-01"}, "MINTGB": {"colors": ["#f4f2af", "#64d0b8", "#3b7961", "#291f3e"], "description": "MINTGB"}, "YOGHURT": {"colors": ["#39254e", "#5951bb", "#d765bf", "#d5a2e2"], "description": "YOGHURT"}, "SLATE - SNURLY": {"colors": ["#beb09f", "#608189", "#49556c", "#292736"], "description": "SLATE - SNURLY"}, "mononoke": {"colors": ["#03324e", "#c74148", "#dbb9a0", "#ffffff"], "description": "mononoke"}, "AGB2": {"colors": ["#1e4959", "#3ba155", "#a0c76f", "#ebe0b2"], "description": "AGB2"}, "1 bit monitor glow": {"colors": ["#222323", "#f0f6f0"], "description": "1 bit monitor glow"}, "Ice Cream GB Palette": {"colors": ["#7c3f58", "#eb6b6f", "#f9a875", "#fff6d3"], "description": "Ice Cream GB Palette"}, "LAVA GB": {"colors": ["#051f39", "#4a2480", "#c53a9d", "#ff8e80"], "description": "LAVA GB"}, "DEMICHROME": {"colors": ["#211e20", "#555568", "#a0a08b", "#e9efec"], "description": "DEMICHROME"}, "MOONLIGHT GB": {"colors": ["#0f052d", "#203671", "#36868f", "#5fc75d"], "description": "MOONLIGHT GB"}, "HOLLOWKNIGHT": {"colors": ["#0f0f1b", "#565a75", "#c6b7be", "#fafbf6"], "description": "HOLLOWKNIGHT"}, "BITBEE": {"colors": ["#292b30", "#cfab4a"], "description": "BITBEE"}, "SPACE HAZE": {"colors": ["#f8e3c4", "#cc3495", "#6b1fb1", "#0b0630"], "description": "SPACE HAZE"}, "BitterSweet": {"colors": ["#282328", "#545c7e", "#c56981", "#a3a29a"], "description": "BitterSweet"}, "BLK-Aqua": {"colors": ["#002b59", "#005f8c", "#00b9be", "#9ff4e5"], "description": "BLK-Aqua"}, "NostalgiaGB": {"colors": ["#d0d058", "#a0a840", "#708028", "#405010"], "description": "NostalgiaGB"}, "HALLOWEEN": {"colors": ["#300030", "#602878", "#f89020", "#f8f088"], "description": "HALLOWEEN"}, "DUSTBYTE": {"colors": ["#788374", "#f5e9bf", "#aa644d", "#372a39"], "description": "DUSTBYTE"}, "COLDFIREGB": {"colors": ["#46425e", "#5b768d", "#d17c7c", "#f6c6a8"], "description": "COLDFIREGB"}, "HOUND": {"colors": ["#3c1402", "#ca9a57", "#e96f1b", "#312b24"], "description": "HOUND"}, "CRIMSON": {"colors": ["#eff9d6", "#ba5044", "#7a1c4b", "#1b0326"], "description": "CRIMSON"}, "MuddySand": {"colors": ["#e6d69c", "#b4a56a", "#7b7162", "#393829"], "description": "MuddySand"}, "ST GAMEBOy": {"colors": ["#09091a", "#442a8c", "#a8bf4c", "#f4f5e9"], "description": "ST GAMEBOY"}, "2bit Pips": {"colors": ["#3a3522", "#7c3838", "#647859", "#b5a37e"], "description": "2bit Pips"}, "Monday 4": {"colors": ["#ac8876", "#906776", "#634d69", "#353546"], "description": "Monday 4"}, "DreamfulSpace": {"colors": ["#21193c", "#932f7b", "#e67b8b", "#f5d2b8"], "description": "DreamfulSpace"}, "Snowflake 4": {"colors": ["#e7edeb", "#8ecece", "#62a1c7", "#3f6ecc"], "description": "Snowflake 4"}, "WISH": {"colors": ["#622e4c", "#7550e8", "#608fcf", "#8be5ff"], "description": "WISH"}, "Luxa": {"colors": ["#1e1e3c", "#50506e", "#bebee6", "#e6e6ff"], "description": "Luxa"}, "LemonLime": {"colors": ["#28375b", "#39809c", "#5fcc86", "#fff37b"], "description": "LemonLime"}, "RUSTIC": {"colors": ["#2c2137", "#764462", "#edb4a1", "#a96868"], "description": "RUSTIC"}, "MISTGB": {"colors": ["#2d1b00", "#1e606e", "#5ab9a8", "#c4f0c2"], "description": "MISTGB"}, "2bitdemi": {"colors": ["#211e20", "#555568", "#a0a08b", "#e9efec"], "description": "2bitdemi"}, "HEY": {"colors": ["#1880f8", "#151515", "#ff82ce", "#ffe737"], "description": "HEY"}, "ButI": {"colors": ["#000000", "#2234d1", "#aa0000", "#aaaaaa"], "description": "ButI"}, "LOSPEC": {"colors": ["#000000", "#382843", "#7c6d80", "#c7c6c6"], "description": "LOSPEC"}, "REDBLOODPAIN": {"colors": ["#7e1f23", "#c4181f", "#120a19", "#5e4069"], "description": "REDBLOODPAIN"}, "PEPNO": {"colors": ["#101323", "#d6d4cb", "#711919"], "description": "PEPNO"}, "bicycle": {"colors": ["#161616", "#ab4646", "#8f9bf6", "#f0f0f0"], "description": "bicycle"}, "BLUEMOLD": {"colors": ["#191b1a", "#294257", "#579c9a", "#99c9b3"], "description": "BLUEMOLD"}, "GOLDGB": {"colors": ["#210b1b", "#4d222c", "#9d654c", "#cfab51"], "description": "GOLDGB"}, "FIERYPLAGUE": {"colors": ["#1a2129", "#312137", "#512839", "#713141"], "description": "FIERYPLAGUE"}, "moonccrystal": {"colors": ["#ffe2db", "#d9a7c6", "#8d89c7", "#755f9c"], "description": "moonccrystal"}, "kaneik4": {"colors": ["#ffffff", "#f42e1f", "#2f256b", "#060608"], "description": "kaneik4"}, "AMERICANA": {"colors": ["#fce4a8", "#71969f", "#d71a21", "#01334e"], "description": "AMERICANA"}, "PASTLITO": {"colors": ["#4b475c", "#d7dedc"], "description": "PASTLITO"}}, "Horror": {"purpledawn": {"colors": ["#eefded", "#9a7bbc", "#2d757e", "#001b2e"], "description": "purpledawn"}, "rising sunset": {"colors": ["#181322", "#4b372c", "#a2423a", "#cdc1a7"], "description": "rising sunset"}, "amber crt gb": {"colors": ["#0d0405", "#5e1210", "#d35600", "#fed018"], "description": "amber crt gb"}, "empty space": {"colors": ["#000100", "#431723", "#46464f", "#928e80"], "description": "empty space"}, "voltage warning": {"colors": ["#1c1412", "#635650", "#d3ae21", "#d4c9c3"], "description": "voltage warning"}, "look of horror": {"colors": ["#0a202f", "#302d6a", "#871c3e", "#d32836"], "description": "look of horror"}, "Vivid Sceam": {"colors": ["#561d17", "#5c4fa3", "#74af34", "#caf532"], "description": "Vivid Sceam"}, "BarbieSlasher": {"colors": ["#000000", "#6e1fb1", "#cc3385", "#f8fbf3"], "description": "BarbieSlasher"}, "Mushroom": {"colors": ["#2b4158", "#8b6f7b", "#caaea3", "#fff9f1"], "description": "Mushroom"}, "MokkyBrown": {"colors": ["#cca66e", "#99683d", "#664930", "#332920"], "description": "MokkyBrown"}, "Candy Pop": {"colors": ["#301221", "#854576", "#9e81d0", "#eebff5"], "description": "Candy Pop"}, "Caramel Autumn": {"colors": ["#290143", "#a22fc9", "#ff8b40", "#fff4b8"], "description": "Caramel Autumn"}, "BlushGB": {"colors": ["#b03e80", "#ff8acd", "#4aedff", "#ffffff"], "description": "BlushGB"}, "mangavania": {"colors": ["#fe9192", "#fcdebe", "#0cc0d4", "#5e5768"], "description": "mangavania"}, "STARPOP": {"colors": ["#674577", "#64b9ca", "#ffa3d6", "#ffebe5"], "description": "STARPOP"}, "Triple Fin": {"colors": ["#ffcfb9", "#ffaec9", "#fe5ba9", "#b01550"], "description": "Triple Fin"}, "Italy": {"colors": ["#100f24", "#5d8d60", "#edeada", "#c74634"], "description": "Italy"}, "Black-White": {"colors": ["#000000", "#ffffff"], "description": "Custom palette - click Edit to modify"}}};

  // State & refs
  const state={images:[],palette:[],paletteLab:[]};
  const dropzone=document.getElementById('dropzone'),fileInput=document.getElementById('fileInput'),thumbs=document.getElementById('thumbs');
  const origCanvas=document.getElementById('origCanvas'),convCanvas=document.getElementById('convCanvas');
  const origMeta=document.getElementById('origMeta'),convMeta=document.getElementById('convMeta');
  const systemSelect=document.getElementById('systemSelect'),paletteSelect=document.getElementById('paletteSelect'),swatches=document.getElementById('swatches');
  const maxColorsEl=document.getElementById('maxColors'),ditherModeEl=document.getElementById('ditherMode'),ditherStrengthEl=document.getElementById('ditherStrength');
  const distanceModeEl=document.getElementById('distanceMode'),gammaEl=document.getElementById('gamma'),alphaThreshEl=document.getElementById('alphaThresh');
  const brightnessEl=document.getElementById('brightness'),contrastEl=document.getElementById('contrast'),saturationEl=document.getElementById('saturation');
  const posterizeEl=document.getElementById('posterize'),toleranceEl=document.getElementById('tolerance'),grayscaleEl=document.getElementById('grayscale');
  const exportScaleEl=document.getElementById('exportScale');
  const importPalettesBtn=document.getElementById('importPalettes');
  const convertAllBtn=document.getElementById('convertAll');
  const downloadPNGBtn=document.getElementById('downloadPNG');
  const downloadAllBtn=document.getElementById('downloadAll');
  const clearAllBtn=document.getElementById('clearAll');
  const resetViewBtn=document.getElementById('resetView');

  // Build selectors
  function refreshSystemSelect(){systemSelect.innerHTML='';Object.keys(PALETTES).forEach(sys=>{const o=document.createElement('option');o.value=sys;o.textContent=sys;systemSelect.appendChild(o);});systemSelect.value=Object.keys(PALETTES)[0]||'';refreshPaletteSelect();}
  function refreshPaletteSelect(){const sys=systemSelect.value;const palObj=PALETTES[sys]||{};paletteSelect.innerHTML='';Object.keys(palObj).forEach(p=>{const o=document.createElement('option');o.value=p;o.textContent=p;paletteSelect.appendChild(o);});paletteSelect.value=Object.keys(palObj)[0]||'';buildSwatches();}

  // Swatches: chips only (no hex text)
  function buildSwatches(){const pal=(PALETTES[systemSelect.value]||{})[paletteSelect.value];if(!pal){swatches.innerHTML='';return;}swatches.innerHTML='';const colors=pal.colors||[];const maxc=parseInt(maxColorsEl.value||'0',10);const chosen=(maxc>0)?colors.slice(0,maxc):colors;chosen.forEach((hex,idx)=>{const chip=document.createElement('div');chip.className='chip';chip.style.background=hex;chip.title=hex;chip.onclick=()=>{const inp=document.createElement('input');inp.type='color';inp.value=hex;inp.style.position='absolute';inp.style.left='-9999px';document.body.appendChild(inp);inp.click();inp.oninput=()=>{chosen[idx]=inp.value;pal.colors[idx]=inp.value;updateCurrentPalette();convertCurrent();chip.style.background=inp.value;document.body.removeChild(inp);};inp.onblur=()=>document.body.removeChild(inp);};swatches.appendChild(chip);});updateCurrentPalette();}

  function updateCurrentPalette(){const palHex=(PALETTES[systemSelect.value]||{})[paletteSelect.value]?.colors||[];const maxc=parseInt(maxColorsEl.value||'0',10);const chosen=(maxc>0)?palHex.slice(0,maxc):palHex;state.palette=chosen.map(hexToRgb);state.paletteLab=state.palette.map(rgbToLab);} 

  systemSelect.onchange=()=>{refreshPaletteSelect();convertCurrent();};
  paletteSelect.onchange=()=>{buildSwatches();convertCurrent();};
  maxColorsEl.oninput=()=>{buildSwatches();convertCurrent();};
  maxColorsEl.onchange=()=>{buildSwatches();convertCurrent();};

  // Drag & drop
  function handleFiles(files){[...files].forEach(file=>{if(!file.type.startsWith('image/'))return;const reader=new FileReader();reader.onload=e=>{const img=new Image();img.onload=()=>addImage(file.name,img);img.src=e.target.result;};reader.readAsDataURL(file);});}
  function addImage(name,img){const wrap=document.createElement('div');wrap.className='thumb';const c=document.createElement('canvas');const ctx=c.getContext('2d');const size=256;c.width=size;c.height=size;ctx.imageSmoothingEnabled=false;const scale=Math.min(size/img.width,size/img.height);const w=Math.round(img.width*scale),h=Math.round(img.height*scale);ctx.drawImage(img,(size-w)/2,(size-h)/2,w,h);const meta=document.createElement('div');meta.className='meta';meta.textContent=name;wrap.appendChild(c);wrap.appendChild(meta);wrap.onclick=()=>selectImage(name);thumbs.appendChild(wrap);state.images.push({name,img});if(state.images.length===1)selectImage(name);} 
  function selectImage(name){const item=state.images.find(i=>i.name===name);if(!item)return;origCanvas.width=item.img.width;origCanvas.height=item.img.height;const octx=origCanvas.getContext('2d');octx.imageSmoothingEnabled=false;octx.drawImage(item.img,0,0);origMeta.textContent=`${item.img.width}×${item.img.height}`;convertCurrent();}
  dropzone.addEventListener('dragover',e=>{e.preventDefault();dropzone.classList.add('drag');});dropzone.addEventListener('dragleave',e=>{dropzone.classList.remove('drag');});dropzone.addEventListener('drop',e=>{e.preventDefault();dropzone.classList.remove('drag');handleFiles(e.dataTransfer.files);});dropzone.addEventListener('click',()=>fileInput.click());fileInput.onchange=()=>handleFiles(fileInput.files);

  // Pre‑processing
  function applyPreprocessing(imgData){const d=imgData.data;const len=d.length;const b=parseInt(brightnessEl.value,10);const c=parseInt(contrastEl.value,10);const s=parseInt(saturationEl.value,10);const poster=parseInt(posterizeEl.value,10);const doGray=grayscaleEl.checked;const bShift=(255*b/100)|0;const cFactor=Math.pow((100+c)/100,2);function toGray(r,g,b){return (0.2126*r+0.7152*g+0.0722*b)|0;}for(let i=0;i<len;i+=4){let r=d[i],g=d[i+1],b_=d[i+2],a=d[i+3];if(a<=parseInt(alphaThreshEl.value,10)){d[i+3]=0;continue;}r=clamp(r+bShift,0,255);g=clamp(g+bShift,0,255);b_=clamp(b_+bShift,0,255);r=clamp(((r-128)*cFactor)+128,0,255);g=clamp(((g-128)*cFactor)+128,0,255);b_=clamp(((b_-128)*cFactor)+128,0,255);const hsv=rgbToHsv([r,g,b_]);hsv[1]=clamp(hsv[1]+(s/100),0,1);const h=hsv[0]/360,sat=hsv[1],v=hsv[2];const iHue=Math.floor(h*6);const f=h*6-iHue;const p=v*(1-sat),q=v*(1-f*sat),t=v*(1-(1-f)*sat);let rr,gg,bb;switch(iHue%6){case 0:rr=v;gg=t;bb=p;break;case 1:rr=q;gg=v;bb=p;break;case 2:rr=p;gg=v;bb=t;break;case 3:rr=p;gg=q;bb=v;break;case 4:rr=t;gg=p;bb=v;break;case 5:rr=v;gg=p;bb=q;break;}r=(rr*255)|0;g=(gg*255)|0;b_=(bb*255)|0;if(doGray){const gr=toGray(r,g,b_);r=gr;g=gr;b_=gr;}if(poster>0){const step=255/Math.max(1,poster-1);r=Math.round(r/step)*step;g=Math.round(g/step)*step;b_=Math.round(b_/step)*step;}d[i]=r;d[i+1]=g;d[i+2]=b_;}return imgData;}

  // Matching & dithering
  function findClosestColor(rgb){const mode=distanceModeEl.value;let bestIdx=0,bestDist=Infinity;const lab1=(mode.startsWith('lab'))?rgbToLab(rgb):null;const hsv1=(mode==='hsv')?rgbToHsv(rgb):null;for(let i=0;i<state.palette.length;i++){const p=state.palette[i];let d=0;if(mode==='rgb'){d=(rgb[0]-p[0])**2+(rgb[1]-p[1])**2+(rgb[2]-p[2])**2;}else if(mode==='rgb-gamma'){const r1=srgbToLinear(rgb[0]/255),g1=srgbToLinear(rgb[1]/255),b1=srgbToLinear(rgb[2]/255);const r2=srgbToLinear(p[0]/255),g2=srgbToLinear(p[1]/255),b2=srgbToLinear(p[2]/255);d=(r1-r2)**2+(g1-g2)**2+(b1-b2)**2;}else if(mode==='lab-de2000'){d=(function(lab1,lab2){const [L1,a1,b1]=lab1;const [L2,a2,b2]=lab2;const avgLp=(L1+L2)/2;const C1=Math.sqrt(a1*a1+b1*b1),C2=Math.sqrt(a2*a2+b2*b2);const avgC=(C1+C2)/2;const G=0.5*(1-Math.sqrt(Math.pow(avgC,7)/(Math.pow(avgC,7)+Math.pow(25,7))));const a1p=(1+G)*a1,a2p=(1+G)*a2;const C1p=Math.sqrt(a1p*a1p+b1*b1),C2p=Math.sqrt(a2p*a2p+b2*b2);const avgCp=(C1p+C2p)/2;const h1p=Math.atan2(b1,a1p),h2p=Math.atan2(b2,a2p);const hpFunc=h=>h>=0?h:h+2*Math.PI;const h1pd=hpFunc(h1p),h2pd=hpFunc(h2p);const dh=h2pd-h1pd;const deltahp=(Math.abs(dh)<=Math.PI)?dh:(dh>0?dh-2*Math.PI:dh+2*Math.PI);const deltaLp=L2-L1,deltaCp=C2p-C1p,deltaHp=2*Math.sqrt(C1p*C2p)*Math.sin(deltahp/2);const avgHp=(Math.abs(h1pd-h2pd)<=Math.PI)?(h1pd+h2pd)/2:((h1pd+h2pd<2*Math.PI)?(h1pd+h2pd+2*Math.PI)/2:(h1pd+h2pd-2*Math.PI)/2);const T=1-0.17*Math.cos(avgHp-Math.PI/6)+0.24*Math.cos(2*avgHp)+0.32*Math.cos(3*avgHp+Math.PI/30)-0.20*Math.cos(4*avgHp-63*Math.PI/180);const Sl=1+(0.015*Math.pow(avgLp-50,2))/Math.sqrt(20+Math.pow(avgLp-50,2));const Sc=1+0.045*avgCp;const Sh=1+0.015*avgCp*T;const deltaTheta=30*Math.PI/180*Math.exp(-Math.pow((avgHp*180/Math.PI-275)/25,2));const Rc=2*Math.sqrt(Math.pow(avgCp,7)/(Math.pow(avgCp,7)+Math.pow(25,7)));const Rt=-Rc*Math.sin(2*deltaTheta);const kl=1,kc=1,kh=1;return Math.sqrt(Math.pow(deltaLp/(Sl*kl),2)+Math.pow(deltaCp/(Sc*kc),2)+Math.pow(deltaHp/(Sh*kh),2)+Rt*(deltaCp/(Sc*kc))*(deltaHp/(Sh*kh)));})(lab1,state.paletteLab[i]);}else if(mode==='lab-de76'){d=deltaE76(lab1,state.paletteLab[i]);}else if(mode==='hsv'){d=hsvDist(hsv1,rgbToHsv(p));}if(d<bestDist){bestDist=d;bestIdx=i;}}return state.palette[bestIdx];}

  const BAYER4=[[0,8,2,10],[12,4,14,6],[3,11,1,9],[15,7,13,5]];
  const BAYER8=(function(){const b4=BAYER4;const out=[...Array(8)].map(()=>Array(8).fill(0));for(let y=0;y<8;y++)for(let x=0;x<8;x++){const v=b4[y%4][x%4]*4+b4[Math.floor(y/2)%4][Math.floor(x/2)%4];out[y][x]=v;}return out;})();
  function orderedDither(data,w,h,matrix){const strength=parseFloat(ditherStrengthEl.value);const size=matrix.length;for(let y=0;y<h;y++){for(let x=0;x<w;x++){const idx=(y*w+x)*4;const a=data[idx+3];if(a===0)continue;const threshold=(matrix[y%size][x%size]/(size*size))*255;const r=clamp(data[idx]+strength*threshold-0.5*strength*255,0,255)|0;const g=clamp(data[idx+1]+strength*threshold-0.5*strength*255,0,255)|0;const b=clamp(data[idx+2]+strength*threshold-0.5*strength*255,0,255)|0;const c=findClosestColor([r,g,b]);data[idx]=c[0];data[idx+1]=c[1];data[idx+2]=c[2];}}}
  function errorDiffuse(data,w,h,kernel){const weights=kernel.weights;const div=kernel.div;const strength=parseFloat(ditherStrengthEl.value);for(let y=0;y<h;y++){for(let x=0;x<w;x++){const idx=(y*w+x)*4;const a=data[idx+3];if(a===0)continue;const old=[data[idx],data[idx+1],data[idx+2]];const newc=findClosestColor(old);data[idx]=newc[0];data[idx+1]=newc[1];data[idx+2]=newc[2];const err=[old[0]-newc[0],old[1]-newc[1],old[2]-newc[2]];for(let i=0;i<weights.length;i++){const wx=x+weights[i].dx,wy=y+weights[i].dy;if(wx<0||wy<0||wx>=w||wy>=h)continue;const widx=(wy*w+wx)*4;const f=(weights[i].w/div)*strength;data[widx]=clamp(data[widx]+err[0]*f,0,255);data[widx+1]=clamp(data[widx+1]+err[1]*f,0,255);data[widx+2]=clamp(data[widx+2]+err[2]*f,0,255);}}}}
  const KERNELS={fs:{div:16,weights:[{dx:1,dy:0,w:7},{dx:-1,dy:1,w:3},{dx:0,dy:1,w:5},{dx:1,dy:1,w:1}]},jjn:{div:48,weights:[{dx:1,dy:0,w:7},{dx:2,dy:0,w:5},{dx:-2,dy:1,w:3},{dx:-1,dy:1,w:5},{dx:0,dy:1,w:7},{dx:1,dy:1,w:5},{dx:2,dy:1,w:3},{dx:-2,dy:2,w:1},{dx:-1,dy:2,w:3},{dx:0,dy:2,w:5},{dx:1,dy:2,w:3},{dx:2,dy:2,w:1}]},atkinson:{div:8,weights:[{dx:1,dy:0,w:1},{dx:2,dy:0,w:1},{dx:-1,dy:1,w:1},{dx:0,dy:1,w:1},{dx:1,dy:1,w:1},{dx:0,dy:2,w:1}]}};

  // Convert
  function convertCurrent(){const w=origCanvas.width,h=origCanvas.height;if(w*h===0)return;const ctx=origCanvas.getContext('2d');let imgData=ctx.getImageData(0,0,w,h);imgData=applyPreprocessing(imgData);const data=imgData.data;const tol=parseFloat(toleranceEl.value||'0');if(ditherModeEl.value==='none'){for(let i=0;i<data.length;i+=4){if(data[i+3]===0)continue;const orig=[data[i],data[i+1],data[i+2]];const c=findClosestColor(orig);const de=deltaE76(rgbToLab(orig),rgbToLab(c));if(de>tol){data[i]=c[0];data[i+1]=c[1];data[i+2]=c[2];}}}else if(ditherModeEl.value==='ordered4'){orderedDither(data,w,h,BAYER4);}else if(ditherModeEl.value==='ordered8'){orderedDither(data,w,h,BAYER8);}else{errorDiffuse(data,w,h,KERNELS[ditherModeEl.value]);}const cctx=convCanvas.getContext('2d');convCanvas.width=w;convCanvas.height=h;cctx.putImageData(new ImageData(data,w,h),0,0);convMeta.textContent=`${state.palette.length} colors • ${distanceModeEl.options[distanceModeEl.selectedIndex].text} • ${ditherModeEl.options[ditherModeEl.selectedIndex].text}`;}

  // Import for outside users
  importPalettesBtn.onclick = async ()=>{
    try{
      const [fileHandle] = await showOpenFilePicker({ types:[{ description:'JSON', accept:{ 'application/json':['.json'] } }] });
      const file = await fileHandle.getFile(); const txt = await file.text(); const json = JSON.parse(txt);
      Object.keys(json).forEach(sys=>{ if(!PALETTES[sys]) PALETTES[sys] = {}; Object.assign(PALETTES[sys], json[sys]); });
      refreshSystemSelect();
      alert('Palettes imported.');
    }catch(e){ console.warn(e); }
  };

  // Other events
  [distanceModeEl,ditherModeEl,ditherStrengthEl,gammaEl,alphaThreshEl,brightnessEl,contrastEl,saturationEl,posterizeEl,toleranceEl,grayscaleEl].forEach(el=>{ el.addEventListener('change', convertCurrent); el.addEventListener('input', convertCurrent); });
  convertAllBtn.onclick=convertCurrent;
  resetViewBtn.onclick=()=>{exportScaleEl.value=1;window.scrollTo({top:0,behavior:'smooth'});};

  // Export current PNG
  downloadPNGBtn.onclick=()=>{const scale=parseInt(exportScaleEl.value||'1',10);const w=convCanvas.width*scale,h=convCanvas.height*scale;const out=document.createElement('canvas');out.width=w;out.height=h;const ctx=out.getContext('2d');ctx.imageSmoothingEnabled=false;ctx.drawImage(convCanvas,0,0,w,h);const a=document.createElement('a');a.href=out.toDataURL('image/png');a.download=`converted_${systemSelect.value.replace(/\s+/g,'-')}_${paletteSelect.value.replace(/\s+/g,'-')}.png`;a.click();};
  downloadAllBtn.onclick=()=>{const scale=parseInt(exportScaleEl.value||'1',10);state.images.forEach(item=>{origCanvas.width=item.img.width;origCanvas.height=item.img.height;const octx=origCanvas.getContext('2d');octx.imageSmoothingEnabled=false;octx.drawImage(item.img,0,0);convertCurrent();const w=convCanvas.width*scale,h=convCanvas.height*scale;const out=document.createElement('canvas');out.width=w;out.height=h;const ctx=out.getContext('2d');ctx.imageSmoothingEnabled=false;ctx.drawImage(convCanvas,0,0,w,h);const base=item.name.replace(/\.[^.]+$/, '');const a=document.createElement('a');a.href=out.toDataURL('image/png');a.download=`${base}_${systemSelect.value.replace(/\s+/g,'-')}_${paletteSelect.value.replace(/\s+/g,'-')}.png`;a.click();});};
  clearAllBtn.onclick=()=>{state.images=[];thumbs.innerHTML='';origCanvas.width=origCanvas.height=convCanvas.width=convCanvas.height=0;origMeta.textContent='';convMeta.textContent='';};

  // Boot
  refreshSystemSelect();
  </script>
</body>
</html>
